@model InvoiceApplication.Models.Invoice_Table


@{
    ViewData["Title"] = "EditInvoice";
}

<div class="d-flex justify-content-between">
    <h1 class="align-content-center w-25">Edit Invoice</h1>

    <h4 class="align-content-center w-25 text-center">Invoice_Table</h4>

    <a asp-action="Index" class="btn btn-primary m-3 w-25">Cancel</a>
</div>
<hr />
<div class="row w-100">
    <div class="col-md-12">
        <form asp-action="EditInvoice">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input asp-for="Invoice_Number" type="hidden" readonly/>
            <p><strong>Invoice Number</strong> : <i>#@Model.Invoice_Number</i></p>
            <div class="form-group w-25">
                <label asp-for="Invoice_Date" class="control-label"></label>
                <input asp-for="Invoice_Date" type="date" class="form-control" />
                <span asp-validation-for="Invoice_Date" class="text-danger"></span>
            </div>
            <div class="d-flex gap-2">
                <div class="form-group my-2 p-2 border w-50 shippingimg">
                    <h4 class="text-center  text-black-50">Billing Address </h4>
                    <div class="d-flex flex-column">
                        <div class="form-group">
                            <label asp-for="Billing_Name" class="control-label"></label>
                            <input spellcheck="false" asp-for="Billing_Name" class="form-control" />
                            <span asp-validation-for="Billing_Name" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="BillingAddress_Address" class="control-label">Address</label>
                            <textarea spellcheck="false" asp-for="BillingAddress_Address" class="form-control" rows="3"></textarea>
                        </div>
                        <div>
                            <label asp-for="BillingAddress_State" class="control-label">State : </label>
                            <select id="BillState" asp-for="BillingAddress_State" class="form-control">
                                <option value=""> --    select state    --</option>

                            </select>
                        </div>
                        <div>
                            <label asp-for="BillingAddress_City" class="control-label">City : </label>
                            <select id="BillCity" asp-for="BillingAddress_City" class="form-control"></select>
                        </div>
                        <div>
                            <label asp-for="BillingAddress_Phone" class="control-label">Contact : </label>
                            <input asp-for="BillingAddress_Phone" maxlength="10" class="form-control" />
                        </div>
                    </div>
                </div>

                <div class="form-group my-2 p-2 border w-50">
                    <h4 class="text-center text-black-50">Shipping Address</h4>
                    <div class="d-flex flex-column">
                        <div class="form-group">
                            <label asp-for="Shipping_Name" class="control-label"></label>
                            <input spellcheck="false" asp-for="Shipping_Name" class="form-control" />
                            <span asp-validation-for="Shipping_Name" class="text-danger"></span>
                        </div>
                        <div>
                            <label asp-for="ShippingAddress_Address" class="control-label">Address : </label>
                            <textarea spellcheck="false" asp-for="ShippingAddress_Address" class="form-control" rows="3"></textarea>
                        </div>
                        <div>
                            <label asp-for="ShippingAddress_State" class="control-label">State : </label>
                            <select asp-for="ShippingAddress_State" id="ShipState" class="form-control">
                                <option value=""> --    select state    --</option>

                            </select>
                        </div>
                        <div>
                            <label asp-for="ShippingAddress_City" class="control-label"> City : </label>
                            <select asp-for="ShippingAddress_City" id="ShipCity" class="form-control">
                            </select>
                        </div>
                        <div>
                            <label asp-for="ShippingAddress_Phone" class="control-label">Contact : </label>
                            <input asp-for="ShippingAddress_Phone" maxlength="10" class="form-control" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group  d-flex flex-column my-2">
                <label class="control-label">Product Add :</label>

                <div class="d-flex flex-column border p-3">

                    <div class="d-flex justify-content-between gap-2">
                        <input type="text" id="ProductAdd" class="form-control" placeholder="Product Name" />
                        <input type="number" id="Price" class="form-control" placeholder="Price" />
                        <input type="number" id="Quantity" class="form-control" placeholder="Quantity" />
                        <input type="number" id="TotalAmount" class="form-control" placeholder="Total Amount" readonly />

                        <input type="button" class="btn btn-success mx-2" onclick="addproduct()" value="Add" />
                    </div>

                </div>
            </div>

            <input type="hidden" id="ProductJson" name="ProductJson" />


            <div>
                <table class="table table-bordered" id="productTable">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Price (₹)</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="productBody">
                        @foreach(var p in Model.Products)
                        {
                            <tr>
                                <td>@p.Name</td>
                                <td>@p.Price</td>
                                <td>@p.Qty</td>
                                <td>@p.Total</td>
                                <td>
                                    <input class="btn btn-warning btn-sm" onclick="editRow(this)" value="Edit" />
                                    <input class="btn btn-danger btn-sm" onclick="deleteRow(this)" value="Remove" />
                                </td>
                            </tr>
                        }

                    </tbody>
                </table>
                @* <table class="table table-bordered" id="productTable">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Price (₹)</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="productBody"></tbody>
                </table> *@
            </div>

            <!-- Popup -->
            <div id="editPopup"
                 style="display:none;
            position:fixed;
            top:20%;
            left:35%;
            background:white;
            border:1px solid #aaa;
            padding:20px;
            z-index:999;
            width:300px;">

                <h4>Edit Product</h4>

                <div class="form-group">
                    <label>Name</label>
                    <input id="editName" class="form-control" type="text" />
                </div>

                <div class="form-group my-2">
                    <label>Price</label>
                    <input id="editPrice" class="form-control" type="number" />
                </div>

                <div class="form-group my-2">
                    <label>Quantity</label>
                    <input id="editQty" class="form-control" type="number" />
                </div>

                <div class="d-flex gap-2 mt-3">
                    <input type="button" class="btn btn-success" onclick="saveEdit()" value="Save" />
                    <input type="button" class="btn btn-secondary" onclick="closeEdit()" value="Cancel" />
                </div>
            </div>


            <div class="form-group my-3 text-center">
                <input type="submit" value="Save" onclick="beforeSubmit()" class="btn btn-success" />
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }


    <script>
         function beforeSubmit() {
                    let rows = document.querySelectorAll("#productBody tr");
                    let products = [];
                    rows.forEach(r => {
                        products.push({
                            Name: r.children[0].textContent,
                            Price: r.children[1].textContent,
                            Qty: r.children[2].textContent,
                            Total: r.children[3].textContent
                        });
                    });

                    document.getElementById("ProductJson").value = JSON.stringify(products);
                }


               let currentTR = null;

        function addproduct() {

            let name = document.getElementById("ProductAdd").value;
            let price = document.getElementById("Price").value;
            let qty = document.getElementById("Quantity").value;
            let total = document.getElementById("TotalAmount").value;

            let tbody = document.getElementById("productBody");

            let tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${name}</td>
                <td>${price}</td>
                <td>${qty}</td>
                <td>${total}</td>
                <td >

                    <button type="button" class="btn btn-warning btn-sm" onclick="editRow(this)">Edit</button>

                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">Remove</button>

                </td>
            `;

                tbody.appendChild(tr);

                document.getElementById("ProductAdd").value = "";
                document.getElementById("Price").value = "";
                document.getElementById("Quantity").value = "";
                document.getElementById("TotalAmount").value = "";
            }

           function editRow(btn) {

                currentTR = btn.parentElement.parentElement;

                let name = currentTR.children[0].textContent;
                let price = currentTR.children[1].textContent;
                let qty = currentTR.children[2].textContent;

                document.getElementById("editName").value = name;
                document.getElementById("editPrice").value = price;
                document.getElementById("editQty").value = qty;

                document.getElementById("editPopup").style.display = "block";
            }

            function deleteRow(btn) {
                btn.parentElement.parentElement.remove();
            }


        document.getElementById("Price").addEventListener("input", calculateTotal);
        document.getElementById("Quantity").addEventListener("input", calculateTotal);

        function calculateTotal(){
                    let Quantity = document.getElementById("Quantity").value || 0 ;
                    let Price = document.getElementById("Price").value || 0 ;

                    document.getElementById("TotalAmount").value = Quantity * Price ;
        }

            function saveEdit() {

                let name = document.getElementById("editName").value;
                let price = document.getElementById("editPrice").value;
                let qty = document.getElementById("editQty").value;
                let total = price * qty;

                currentTR.children[0].textContent = name;
                currentTR.children[1].textContent = price;
                currentTR.children[2].textContent = qty;
                currentTR.children[3].textContent = total;

                document.getElementById("editPopup").style.display = "none";
            }

        // function openEditPopup(li, name, price, qty) {
        //     currentLI = li;

        //     document.getElementById("editName").value = name;
        //     document.getElementById("editPrice").value = price;
        //     document.getElementById("editQty").value = qty;

        //     document.getElementById("editPopup").style.display = "block";
        // }

        function closeEdit() {
            document.getElementById("editPopup").style.display = "none";
        }


        // ===== Razor Model Values (Edit page values) =====
        const billingStateValue = "@Model.BillingAddress_State";
        const billingCityValue = "@Model.BillingAddress_City";

        const shippingStateValue = "@Model.ShippingAddress_State";
        const shippingCityValue = "@Model.ShippingAddress_City";

        // ===== State List =====
        const state_list = [
            { state_id: 7, state_name: "Gujarat" },
            { state_id: 11, state_name: "Karnataka" },
            { state_id: 12, state_name: "Kerala" },
            { state_id: 14, state_name: "Maharashtra" },
            { state_id: 20, state_name: "Punjab" },
            { state_id: 21, state_name: "Rajasthan" },
            { state_id: 23, state_name: "Tamil Nadu" },
            { state_id: 24, state_name: "Telangana" },
            { state_id: 26, state_name: "Uttar Pradesh" },
            { state_id: 28, state_name: "West Bengal" },
            { state_id: 29, state_name: "Kerala" }
        ];

        // ===== City List =====
        const city_list = [
            { city_id: 1, city_state_id: 7, city_name: "Ahmedabad" },
            { city_id: 2, city_state_id: 7, city_name: "Surat" },
            { city_id: 3, city_state_id: 7, city_name: "Vadodara" },
            { city_id: 4, city_state_id: 7, city_name: "Rajkot" },

            { city_id: 9, city_state_id: 11, city_name: "Bengaluru" },

            { city_id: 10, city_state_id: 12, city_name: "Kochi" },

            { city_id: 5, city_state_id: 14, city_name: "Mumbai" },
            { city_id: 6, city_state_id: 14, city_name: "Pune" },

            { city_id: 7, city_state_id: 20, city_name: "Amritsar" },
            { city_id: 8, city_state_id: 20, city_name: "Ludhiyana" },

            { city_id: 9, city_state_id: 21, city_name: "Jaipur" },
            { city_id: 17, city_state_id: 21, city_name: "Bhilwada" },

            { city_id: 10, city_state_id: 23, city_name: "Chennai" },
            { city_id: 11, city_state_id: 23, city_name: "Tirupati" },

            { city_id: 12, city_state_id: 24, city_name: "Hyderabad" },

            { city_id: 13, city_state_id: 26, city_name: "Lucknow" },
            { city_id: 18, city_state_id: 26, city_name: "Gorakhpur" },
            { city_id: 19, city_state_id: 26, city_name: "Kanpur" },

            { city_id: 14, city_state_id: 28, city_name: "Kolkata" },

            { city_id: 15, city_state_id: 29, city_name: "Kochi" },
            { city_id: 16, city_state_id: 29, city_name: "Tairumpur" }

        ];

        // ===== Select Elements =====
        const BillState = document.getElementById("BillState");
        const BillCity = document.getElementById("BillCity");
        const ShipState = document.getElementById("ShipState");
        const ShipCity = document.getElementById("ShipCity");

        // ===== On Page Load =====
        window.onload = function () {
            loadBillingStates();
            loadShippingStates();
        };

        // ===== Billing State Load =====
        function loadBillingStates() {
            BillState.innerHTML = `<option value="">-- Select State --</option>`;

            state_list.forEach(state => {
                const opt = document.createElement("option");
                opt.value = state.state_name;
                opt.textContent = state.state_name;

                if (state.state_name === billingStateValue) {
                    opt.selected = true;
                }

                BillState.appendChild(opt);
            });

            if (billingStateValue) {
                loadBillingCities(billingStateValue);
            }
        }

        // ===== Billing City Load =====
        function loadBillingCities(stateName) {
            BillCity.innerHTML = `<option value="">-- Select City --</option>`;

            const state = state_list.find(s => s.state_name === stateName);
            if (!state) return;

            city_list
                .filter(c => c.city_state_id === state.state_id)
                .forEach(city => {
                    const opt = document.createElement("option");
                    opt.value = city.city_name;
                    opt.textContent = city.city_name;

                    if (city.city_name === billingCityValue) {
                        opt.selected = true;
                    }

                    BillCity.appendChild(opt);
                });
        }

        BillState.addEventListener("change", function () {
            loadBillingCities(this.value);
        });

        // ===== Shipping State Load =====
        function loadShippingStates() {
            ShipState.innerHTML = `<option value="">-- Select State --</option>`;

            state_list.forEach(state => {
                const opt = document.createElement("option");
                opt.value = state.state_name;
                opt.textContent = state.state_name;

                if (state.state_name === shippingStateValue) {
                    opt.selected = true;
                }

                ShipState.appendChild(opt);
            });

            if (shippingStateValue) {
                loadShippingCities(shippingStateValue);
            }
        }

        // ===== Shipping City Load =====
        function loadShippingCities(stateName) {
            ShipCity.innerHTML = `<option value="">-- Select City --</option>`;

            const state = state_list.find(s => s.state_name === stateName);
            if (!state) return;

            city_list
                .filter(c => c.city_state_id === state.state_id)
                .forEach(city => {
                    const opt = document.createElement("option");
                    opt.value = city.city_name;
                    opt.textContent = city.city_name;

                    if (city.city_name === shippingCityValue) {
                        opt.selected = true;
                    }

                    ShipCity.appendChild(opt);
                });
        }

        ShipState.addEventListener("change", function () {
            loadShippingCities(this.value);
        });




    </script>

}
