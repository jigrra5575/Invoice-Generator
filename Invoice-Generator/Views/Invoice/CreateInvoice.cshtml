@model InvoiceApplication.Models.Invoice_Table

@{
    ViewData["Title"] = "CreateInvoice";
}

<style>
    .bigbutton:hover {
        transform: scale(0.95);
    }
</style>

<div class="d-flex justify-content-between">
    <h1 class="w-25">CreateInvoice</h1>
    <h4 class="w-25 text-center">Invoice_Table</h4>
    <a asp-action="Index" class="btn btn-primary m-3 w-25 bigbutton">Cancel</a>
</div>
<hr />

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Error</h5>
                </div>
                <div class="modal-body">
                    @ViewBag.ErrorMessage
                    <br />
                    <input id="currenttime" readonly class="form-control mt-2" />
                </div>
                <div class="modal-footer">
                    <a asp-action="CreateInvoice" class="btn btn-secondary">Close</a>
                </div>
            </div>
        </div>
    </div>
}

<form asp-action="CreateInvoice">
    <div class="form-group w-25">
        <label asp-for="Invoice_Date"></label>
        <input asp-for="Invoice_Date" type="date" class="form-control" />
    </div>

    <div class="d-flex gap-3 mt-3">
        <div class="border p-3 w-50">
            <h5>Billing Address</h5>

            <input asp-for="Billing_Name" class="form-control mb-2" placeholder="Sender Name" />
            <textarea asp-for="BillingAddress_Address" class="form-control mb-2" placeholder="ex.123 street North Africa"></textarea>

            <select asp-for="BillingAddress_State" id="BillState" class="form-control mb-2">
                <option value="">Select State</option>
            </select>

            <select asp-for="BillingAddress_City" id="BillCity" class="form-control mb-2">
                <option value=""> --    Select City    --</option>
            </select>
            <input asp-for="BillingAddress_Phone" maxlength="10" class="form-control" placeholder="ex.1234567890" />
        </div>

        <div class="border p-3 w-50">
            <h5>Shipping Address</h5>

            <input asp-for="Shipping_Name" class="form-control mb-2" placeholder="Reciever Name" />
            <textarea asp-for="ShippingAddress_Address" class="form-control mb-2" placeholder="ex.xyz Building LasVegas street "></textarea>

            <select asp-for="ShippingAddress_State" id="ShipState" class="form-control mb-2">
                <option value="">Select State</option>
            </select>

            <select asp-for="ShippingAddress_City" id="ShipCity" class="form-control mb-2">
                <option value=""> --    Select City    --</option>

            </select>
            <input asp-for="ShippingAddress_Phone" maxlength="10" class="form-control" placeholder="ex.1234567890" />
        </div>
    </div>

    <input type="hidden" id="ProductJson" name="ProductJson" />

    <div class="mt-4 border p-3">
        <div class="d-flex gap-2">
            <input id="ProductAdd" class="form-control" placeholder="Product" />
            <input id="Price" type="number" class="form-control" placeholder="Price" />
            <input id="Quantity" type="number" class="form-control" placeholder="Qty" />
            <input id="TotalAmount" readonly class="form-control" placeholder="Total" />
            <button type="button" onclick="addproduct()" class="btn btn-success">Add</button>
        </div>
    </div>

    <table class="table mt-3">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="productBody"></tbody>
    </table>

    <div class="text-center">
        <button type="submit" onclick="beforeSubmit()" class="btn btn-primary">Save</button>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const time = document.getElementById("currenttime");
            if (time) time.value = new Date().toLocaleTimeString();

            const states = [
                "Gujarat","Maharashtra","Rajasthan","Uttar Pradesh",
                "Karnataka","Tamil Nadu","Telangana","West Bengal","Punjab","Kerala"
            ];

            const cities = {
                Gujarat:["Ahmedabad","Surat","Vadodara"],
                Maharashtra:["Mumbai","Pune"],
                Rajasthan:["Jaipur","Bhilwada"],
                "Uttar Pradesh":["Lucknow","Kanpur","Gorakhpur"],
                Karnataka:["Bengaluru"],
                "Tamil Nadu":["Chennai","Tirupati"],
                Telangana:["Hyderabad"],
                "West Bengal":["Kolkata"],
                Punjab:["Amritsar","Ludhiyana"],
                Kerala:["Kochi","Tairumpur"]
            };

            function load(select){
                states.forEach(s=>{
                    select.appendChild(new Option(s,s));
                });
            }

            function bind(stateSel, citySel){
                stateSel.onchange = ()=>{
                    citySel.innerHTML="";
                    (cities[stateSel.value]||[]).forEach(c=>{
                        citySel.appendChild(new Option(c,c));
                    });
                };
            }

            load(BillState); load(ShipState);
            bind(BillState,BillCity);
            bind(ShipState,ShipCity);
        });

        function calculate(){
            TotalAmount.value = (Price.value||0)*(Quantity.value||0);
        }
        Price.oninput = Quantity.oninput = calculate;

        function addproduct(){
            productBody.insertAdjacentHTML("beforeend",
                `<tr>
                    <td>${ProductAdd.value}</td>
                    <td>${Price.value}</td>
                    <td>${Quantity.value}</td>
                    <td>${TotalAmount.value}</td>
                    <td><button type="button" onclick="this.closest('tr').remove()" class="btn btn-danger btn-sm">X</button></td>
                </tr>`
            );
            ProductAdd.value=Price.value=Quantity.value=TotalAmount.value="";
        }

        function beforeSubmit(){
            let p=[];
            document.querySelectorAll("#productBody tr").forEach(r=>{
                p.push({
                    Name:r.children[0].innerText,
                    Price:r.children[1].innerText,
                    Qty:r.children[2].innerText,
                    Total:r.children[3].innerText
                });
            });
            ProductJson.value = JSON.stringify(p);
        }
    </script>
}
